# 실행 계획

- MySQL 서버에서 보여주는 실행 계획을 읽고 이해하려면 MySQL 서버가 데이터를 처리하는 로직을 이해할 필요가 있다.

## 통계 정보

- MySQL 서버는 5.7 버전까지 테이블과 인덱스에 대한 개괄적인 정보를 가지고 실행 계획을 수립했다.
	- 하지만 이는 테이블 컬럼의 값이 실제로 어떻게 분포돼 있는지에 대한 정보가 없기 때문에 실행 계획의 정확도가 떨어지는 경우가 많았다.
- MySQL 8.0 버전부터는 인덱스되지 않는 컬럼들에 대해서도 데이터 분포도를 수집해 저장하는 히스토그램 정보가 도입됐다.

### 테이블 및 인덱스 통계 정보

- 비용 기반 최적화에서 가장 중요한 것은 통계 정보다.
	- 예를 들어, 1억 건의 레코드가 저장된 테이블의 통계 정보가 갱신되지 않아서 레코드가 10건 미만인 것처럼 돼 있다면 옵티마이저는 실제 쿼리를 실행할 때 인덱스 레인지 스캔이 아니라 풀 테이블 스캔으로 실행해 버릴 수도 있다.
- MySQL 5.5 버전까지는 각 테이블의 통계 정보가 메모리에만 관리되어서, MySQL 서버가 재시작되면 지금까지 수집된 통계 정보가 모두 사라진다.
- MySQL 5.6 버전부터는 각 테이블의 통계 정보는 mysql 데이터베이스의 `innodb_index_stats` 테이블과 `innodb_table_stats` 테이블로 관리할 수 있게 개선됐다.
- MySQL 5.6에서 테이블을 생성할 때 `STAT_PERSISTENT` 옵션을 설정할 수 있는데, 이 설정값에 따라 테이블 단위로 영구적인 통계 정보를 보관할지 말지 결정할 수 있다.
	- ![](assets/Pasted%20image%2020240730011544.png)
	- 0: 테이블 통계 정보를 메모리에서 관리
	- 1: 테이블의 통계 정보를 mysql 데이터베이스의 `innodb_index_stats` 테이블과 `innodb_table_stats` 테이블로 관리
	- DEFAULT: `innodb_stats_persistent` 시스템 변수의 값으로 결정되며 기본 값은 1.
	- ![](assets/Pasted%20image%2020240730011732.png)
- `ALTER TABLE` 명령으로 테이블의 통계 정보를 영구적으로 또는 단기적으로 변경하는 것을 실행할 수 있다.
	- `ALTER TABLE employees.employees STATS_PERSISTENT=1;`
- `SELECT * FROM innodb_index_stats WHERE database_name='employees' AND TABLE_NAME='employees';`
	- ![](assets/Pasted%20image%2020240730011910.png)
	- ![](assets/Pasted%20image%2020240730011936.png)
- 다음과 같은 이벤트가 발생하면 자동으로 통계 정보가 갱신된다.
	- 테이블이 새로 오픈되는 경우
	- 테이블의 레코드가 대량으로 변경되는 경우(테이블의 전체 레코드 중에서 1/16 정도의 UPDATE 또는 INSERT나 DELETE가 되는 경우)
	- ANALYZE TABLE 명령이 실행되는 경우
	- SHOW TABLE STATUS 명령이나 SHOW INDEX FROM 명령이 실행되는 경우
	- InnoDB 모니터가 활성화 되는 경우
	- innodb_stats_on_metadata 시스템 설정이 ON인 상태에서 SHOW TALBE STATUS 명령이 실행되는 경우
- 영구적인 통계 정보를 사용하고 있다면 `innodb_stats_auto_recalc` 시스템 변수를 OFF로 설정해서 통계 정보가 자동으로 갱신되는 것을 막을 수 있다.
- 통계 정보 샘플링 관련 시스템 변수 2가지
	- `innodb_stats_transient_sample_pages`(기본값 8): 자동으로 통계 정보 수집이 실행될 때 8개의 페이지만 임의로 샘플링해서 분석하고 그 결과로 통계 정보로 활용한다.
	- `innodb_stat_persistent_sample_pages`(기본값  20): `ANALYZE TABLE` 명령이 실행되면 임의로 20개의 페이지만 샘플링해서 분석하고 그 결과를 영구적인 통계 정보 테이블에 저장하고 활용한다.
- 영구적인 통계 정보의 정확도를 높이고싶다면 `innodb_stats_persistent_sample_pages` 시스템 변수에 높은 값을 설정하면되지만, 너무 높이면 통계 정보 수집 시간이 길어지므로 주의해야 한다.