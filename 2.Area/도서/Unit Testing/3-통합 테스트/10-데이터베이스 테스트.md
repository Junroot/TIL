# 데이터베이스 테스트

- 애플리케이션 데이터베이스: 다른 애플리케이션이 접근할 수 없는 데이터베이스

## 데이터베이스 테스트를 위한 전제 조건

- 테슽트를 작성하기 전에 통합 테스트가 가능하게끔 준비 단계를 수행해야 된다.
	- 형상 관리 시스템에 데이터베이스 유지
	- 모든 개발자를 위한 별도의 데이터베이스 인스턴스 사용
	- 데이트베이스 배포에 마이그레이션 기반 방식 적용

### 데이터베이스를 형상 관리 시스템에 유지

- 데이터베이스를 테스트하는 방법의 첫 번째 단계는 데이터베이스 스키마를 일반 코드로 취급하는 것이다.
	- 일반 코드와 마차낙지로 데이터베이스 스키마는 Git과 같은 형상 관리 시스템에 저장하는 것이 최선이다.
- 모델 데이터베이스 방식
	- ![](assets/Pasted%20image%2020231106112423.png)
- 모델 데이터베이스를 사용하는 것은 데이터베이스 스키마를 유지하는 데 상당히 좋지 못한 방법이다.
	- 변경 내역 부재: 데이터베이스 스키마를 과거 특정 시점으로 되돌릴 수 없다. 이는 운영 환경에서 버그를 재현할 때 중요할 수 있다.
	- 복수의 원천 정보: 모델 데이터베이스는 개발 상태에 대한 원천 정보를 둘러싸고 경합하게 된다. 이렇게 기준을 두 가지(GIt과 모델 데이터베이스)로 두면 부담이 가중된다.
- 모든 데이터베이스 스키마 업데이트를 형상 관리 시스템에 두면 원천 정보를 하나로 할 수 있고, 일반 코드 변경과 함께 데이터베이스 변경을 추적할 수 있다.

### 참조 데이터도 데이터베이스 스키마다

- 참조 데이터: 애플리케이션이 제대로 작동하도록 미리 채워야 하는 데이터
- 참조 데이터와 일반 데이터 구별법: 애플리케이션이 데이터를 수정할 수 있으면 일반 데이터고, 그렇지 않으면 참조 데이터다.
- 테이블, 뷰, 인덱스 등의 데이터베이스 스키마는 SQL 스크립트 형태로 표현된다.
	- 개발 중에 언제든지 이러한 스크립트로 기능을 완전히 갖춘 최신 데이터베이스 인스턴스를 만들 수 있어야 한다
- 참조 데이터는 애플리케이션의 필수 사항이므로, 다른 데이터베이스 스키마와 함께 SQL INSET. 문 형태로 형상 관리 시스템에 저장해야 한다.

### 모든 개발자를 위한 별도의 데이터베이스 인스턴스

- 실제 데이터베이스로 테스트하는 것은 충분히 어렵다. 다른 개발자들과 데이터베이스를 공유해야 한다면 훨씬 더 어려워진다.
	- 서로 다른 개발자가 실행한 테스트는 서로 간섭된다.
	- 하위 호환성이 없는 변경으로 다른 개발자의 작업을 막을 수 있기 때문이다.
- 테스트 실행 속도를 그대화하려면 개발자마다 별도의 데이터베이스 인스턴스를 사용하라.

### 상태 기반 데이터베이스 배포와 마이그레이션 기반 데이터베이스 배포

- 마이그레이션 기반 방식은 초기에는 구현하고 유지 보수하기가 어렵지만 장기적으로 상태 기반 방식보다 훨씬 효과적이다.
- 상태 기반 방식
	- 개발 내내 유지 보수하는 모델 데이터베이스가 있다.
	- 배포 중에 비교 도구가 스크립트를 생성해서 운영 데이터베이스를 모델 데이터베이스와 비교해 최신 상태로 유지한다.
	- 차이점: 물리적인 모델 데이터베이스는 원천 데이터가 아니다.
	- 대신 해당 데이터베이스를 작성하는데 사용할 수 있는 SQL 스크립트가 있다.
- 마이그레이션 기반 방식
	- 운영 데이터베이스와 개발 데이터베이스를 자동으로 동기화하기 위한 도구를 쓸 수 없고, 업그레이드 스크립트를 직접 작성해아 한다.
	- 형상 관리에 저장하는 산출물은 데이터베이스 상태가 아닌 마이그레이션이다.
	- 마이그레이션은 일반적으로 평이한 SQL 스크립트로 표시(Flyway, Liquibase 등)하지만, SQL로 변환할 수 있는 DSL 같은 언어를 사용해 작성할 수도 있다.
- 상태 기반 방식보다 마이그레이션 기반 방식을 선호하라
	- 마이그레이션 기반 방식은 데이터 모션 문제를 해결하는 도움이 된다.
	- 데이터 모션: 새로운 데이터베이스 스키마를 준수하도록 기존 데이터의 형태를 변경하는 과정
		- 예: Name 컬럼을 FirstName과 LastName으로 나눈다.
	- 상태 기반 방식은 병합 충돌을 해결하기가 수월하지만, 데이터 모션이 병합 충돌보다 훨씬 더 중요하다.