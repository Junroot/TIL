# 통합 테스트를 하는 이유

- 단위 테스트에만 전적으로 의존하면 시스템이 전체적으로 잘 작동하는지 확신할 수 없다.

## 통합 테스트는 무엇인가?

### 통합 테스트의 역할

- 아래 단위 테스트 세 가지 요구 사항중 하나라도 충족하지 못하면 통합 테스트의 범주에 속한다.
	- 단일 동작 단위를 검증하고,
	- 빠르게 수행하고,
	- 다른 테스트와 별도로 처리한다.
- 단위 테스트는 도메인 모델을 다루는 반면, 통합 테스트는 프로세스 외부 의존성과 도메인 모델을 연결하는 코드(컨트롤러)를 확인한다.

### 다시 보는 테스트 피라미드

- 통합 테스트는 유지비가 많이 든다.
	- 프로세스 외부 의존성 운영이 필요함
	- 관련된 협력자가 많아서 테스트가 비대해짐
- 단위 테스트로 가능한 한 많이 비즈니스 시나리오의 예외 상황을 확인하고, 통합 테스트는 주요 흐름(happy path)과 단위 테스트가 다루지 못하는 기타 예외 상황을 다룬다.
- 대부분을 단위 테스트로 전환하면 유지비를 절감할 수 있고, 단위 테스트와 통합 테스트 사이의 피라디므 같은 비율을 만든다.
- 복잡도가 낮은 단순 애플리케이션은 도메인 모델과 알고리즘 사분면에 코드가 거의 없어, 피라미드 대신 작사각형 모양이 된다.

### 통합 테스트와 빠른 실패

- 통합 테스트에서 프로세스 외부 의존성과 상호 작용을 모두 확인하려면 가장 긴 주요 흐름을 선택하라.
- 이렇게 모든 상호 작용을 거치는 흐름이 없으면, 외부 시스템과의 통신을 모두 확인하는 데 필요한 만큼 통합 테스트를 추가로 작성하라.
- 어떤 예외 상황에 잘못 실행돼 전체 애플리케이션이 즉시 실패하면 해당 예외 상황은 테스트할 필요가 없다.
	- 좋지 않은 테스트를 작성하는 것보다는 테스트를 작성하지 않는 것이 좋다.
- 빠른 실패 원칙: 예기치 않는 오류가 발생하자마자 현재 연산을 중단하는 것을 의미한다. 이 원칙은 다음을 통해 애플리케이션의 안정성을 높인다.
	- 피드백 루프 단축: 버그를 빨리 발견할수록 더 쉽게 해결할 수 있다. 이미 운영 환경으로 넘어온 버그는 개발 중에 발견된 버그보다 수정 비용이 훨씬 더 크다.
	- 지속성 상태 보호: 버그는 애플리케이션 상태를 손상시킨다. 손상된 상태가 데이터베이스로 침투하면, 고치기가 훨씬 어려워진다. 빨리 실패하면 손상이 확산되는 것을 막을 수 있다.

## 어떤 프로세스 외부 의존성을 직접 테스트해야 하는가?

- 외부 의존성 검증 구현 방식 두 가지
	- 실제 프로세스 외부 의존성을 사용한다.
	- 목으로 대체한다.

### 프로세스 외부 의존성의 두 가지 유형

- 프로세스 외부 의존성은 두 가지 범주로 나뉜다.
	- 관리 의존성(전체를 제어할 수 있는 프로세스 외부 의존성): 애플리케이션을 통해서만 접근할 수 이쓰며, 해당 의존성과의 상호 작용은 외부 환경에서 볼 수 없다.
		- 예: 데이터베이스 등
	- 비관리 의존성(전체를 제어할 수 없는 프로세스 외부 의존성): 해당 의존성과의 상호 작용을 외부에서 볼 수 있다.
		- 예: SMTP 서버, 메시지 버스 등
- 관리 의존성은 실제 인스턴스를 사용하고, 비관리 의존성은 목으로 대체한다.
	- 관리 의존성과의 통신은 구현 세부 사항이다.
	- 비관리 의존성과의 통신은 식별할 수 있는 동작이다.

### 관리 의존성이면서 비관리 의존성인 프로세스 외부 의존성 다루기

- 관리 의존성과 비관리 의존성 모두의 속성을 나타내는 프로세스 외부 의존성의 예: 다른 애플리케이션이 접근할 수 있는 데이터베이스
	- 이러한 경우는 DB테이블이 사실상 메시지 버스 역할이고, 각 행이 메시지 역할을 한다.
	- 테이블을 관리, 비관리 부분으로 나누고 비관리에 해당하는 테이블을 이용한 통신 패턴에는 목을 사용한다.
	- ![](assets/Pasted%20image%2020231024114645.png)
### 통합 테스트에서 실제 데이터베이스를 사용할 수 없으면 어떻게 할까?

- 보안 정책 때문이거나 비용 문제 등으로, 통합 테스트에서 관리 의존성을 실제로 사용할 수 없는 경우도 있다.
- 이런 경우 통합 테스트를 아예 작성하지 말고 도메인 모델의 단위 테스트에만 집중하라.
	- 관리 의존성을 목으로 대체하면 통합 테스트의 리팩터링 내성이 저하되기 때문이다.

## 통합 테스트: 예제

### 엔드 투 엔드 테스트는 어떤가?

- 엔드 투 엔드 테스트는 외부 클라이언트를 모방하므로, 테스트 범위에 포함된 모든 프로세스 외부 의존성을 참조하는 배포된 버전의 애플리케이션을 테스트한다.
- 엔드 투 엔드 테스트는 관리 의존성을 직접 확인해서는 안되고, 애플리케이션을 통해 간접적으로 확인해야 한다.
	- ![](assets/Pasted%20image%2020231024130056.png)
	- ![](assets/Pasted%20image%2020231024130103.png)

### 통합 테스트: 첫 번째 시도

- 준비 구절에서 데이터를 데이터베이스에 직접 삽입하지 않고, 헬퍼 메서드를 만들어 호출한다.
	- 이러한 메서드는 여러 통합 테스트에서 재사용할 수 있다.