# 실패와 지연 처리하기

## 서킷 브레이커 이해하기

- 서킷 브레이커 패턴은 우리가 작성한 코드가 실행에 실패하는 경우에 안전하게 처리되도록 해준다.
	- 마이크로서비스의 경우, 한 마이크로서비스의 실패가 다른 마이크로서비스의 연쇄적인 실패로 확산되는 것을 방지해야 하기 때문에 더 중요하다.
- 서킷 브레이커는 메서드의 호출을 허용하며, 서킷은 닫힘 상태에서 시작된다.
	- 어떤 이류로 실패하면, 서킷 브레이커가 개방되고 실패한 메서드에 더 이상 호출이 수행되지 않는다. 대신 폴백을 제공하여 자체적으로 실패를 처리한다.
	- 개방 상태의 서킷이 때때로 절반-열림 상태로 바뀌면서 실패했던 메서드의 호출을 서킷 브레이커가 다시 시도한다.
		- 여전히 실패하면, 서킷은 다시 열림 상태가 되고, 이후에 다시 폴백 메서드가 호출된다.
		- 성공하면, 문제가 해결된 것으로 간주하여 서킷은 닫힘 상태가 된다.
	- ![](assets/Pasted%20image%2020231023195758.png)
- 주로 서킷 브레이커를 선언할 후보들
	- REST를 호출하는 메서드: 사용할 수 없거나 HTTP 500 응답을 반환하는 원격 서비스로 인해 실패할 수 있는 메서드다.
	- 데이터베이스 쿼리를 수행하는 메서드: 어떤 이유로든 데이터베이스가 무반응 상태가 되거나, 애플리케이션을 중단시킬 수 있는 스키마의 변경이 생기면 실패할 수 있는 메서드다.
	- 느리게 실행될 가능성이 있는 메서드: 너무 오랫동안 실행된다면 비정상적인 상태를 고려할 수 있다.(지연 문제)
- Netflix 오픈 소스 프로젝트가 Hystrix 라이브러리를 사용하여 서킷 브레이크 패턴을 제공한다.

## 서킷 브레이커 선언하기

- 의존성 추가
	- ![](assets/Pasted%20image%2020231023201014.png)
- Hystrix 활성화
	- ![](assets/Pasted%20image%2020231023201033.png)
- 서킷 브레이커가 적용될 메서드에 `@HystrixCommand`를 지정한다.
	- 해당 메서드를 호출 했을 때 예외가 던져지면 `fallbackMethod` 필드에 선언한 메소드를 호출한다.
	- 폴백 메서드는 원래 호출할 메서드와 이름을 제외한 시그니처가 같다.
	- ![](assets/Pasted%20image%2020231023201148.png)
- 폴백 메서드 자신도 서킷 브레이커를 가질 수 있다.
	- 폴백 메서드를 연쇄적으로 사용할 때, 폴백 스택의 제일 밑에는 실행에 실패하지 않아서 서킷 브레이커가 필요 없는 메서드가 있어야 한다.

### 지연 시간 줄이기

- `@HystrixCommand` 애노테이션의 `commandProperties` 속성을 통해 Hystrix 명령 속성을 설정할 수 있다.
- 서킷 브레이커의 타임아웃을 변경하려면 `execution.isolation.thread.timeoutInMilliseconds` 명령 속성을 설정해야 한다.
	- ![](assets/Pasted%20image%2020231023201905.png)
- 타임아웃이 필요 없을 때는 `execution.timeout.enabled`를 `false`로 설정하여 타임아웃을 없앨 수 있다.
	- ![](assets/Pasted%20image%2020231023201932.png)