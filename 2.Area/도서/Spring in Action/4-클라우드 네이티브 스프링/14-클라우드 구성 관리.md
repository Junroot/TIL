# 클라우드 구성 관리

- 스프링 클라우드의 구성 서버는 애플리케이션의 모든 마이크로서비스에 대해 중앙 집중식의 구성(config)를 제공한다.
- 구성 서버를 사용하면 애플리케이션의 모든 구성을 한 곳에서 관리할 수 있다.

## 구성 공유하기

- application.yml 또는 application.properties 파일
	- 속성만 변경하기 위해 애플리케이션을 재배포해야된다.
	- 데이터베이스 비밀번호와 같은 일부속성들은 개발자 조차 접근할 수 없도록 해야한다.
- 자바 시스템 속성이나 운영체제의 환경 변수에 구성 속성을 설정하는 경우
	- 속성의 변경으로 인해 애플리케이션이 재시작되어야 한다.
	- 데이터베이스 비밀번호와 같은 일부속성들은 개발자 조차 접근할 수 없도록 해야한다.
- 중앙 집중식으로 구성을 관리
	- 구성이 더 이상 애플리케이션 코드에 패키징되어 배포되지 않는다.
	- 공통적인 구성을 공유하는 마이크로서비스가 자신의 속성 설정으로 유지, 관리하지 않고도 동일한 속성들을 공유할 수 있다.
	- 보안에 민감한 구성 속성은 애플리케이션 코드와 별도로 암호화하고 유지, 관리할 수 있다.

## 구성 서버 실행하기

- 구성 서버는 클라이언트가 되는 다른 서비스들이 구성 속성을 사용할 수 있도록 REST API를 제공한다.
- Git과 같은 소스 코드 제어 시스템에 구성 속성을 저장함으로써 애플리케이션 소스 코드처럼 구성 속성의 버전, 분기 등을 관리할 수 있다.
	- 구성 속성을 사용하는 애플리케이션과 별도로 구성 속성을 유지, 관리하므로 애플리케이션과 독립적으로 버전을 관리할 수 있다.
- 해시코프의 Vault는 보안 처리된 구성 속성을 유지, 관리할 때 유용하다.
- ![](assets/Pasted%20image%2020230925202612.png)

### 구성 서버 활성화하기

- 스프링 클라우드 구성 서버 스타터 의존성
	- ![](assets/Pasted%20image%2020230925204502.png)
- `@EnableConfigServer` 애노테이션으로 활성화
	- ![](assets/Pasted%20image%2020230925204655.png)
- 구성 서버의 `spring.cloud.config.server.git.uri` 속성으로 속성을 관리할 git 저장소 uri 입력
	- ![](assets/Pasted%20image%2020230925204810.png)
- REST API를 통해서 구성 속성을 요청할 수 있다.
	- `curl localhost:8888/application/default`
	- 브랜치 명은 생략하면 master가 기본값이 된다.
	- ![](assets/Pasted%20image%2020230925205630.png)
	- ![](assets/Pasted%20image%2020230925205602.png)

### Git 리퍼지터리에 구성 속성 저장하기

- Git 리퍼지터리에 저장할 application.yml 파일
	- ![](assets/Pasted%20image%2020230926205407.png)
- `curl localhost:8888/someapp/someconfig` 의 응답 결과

```js
{
	"name": "someapp",
	"profiles": [
		"someconfig"
	],
	"label": null,
	"version": "95df-cbc3bca106199bd804b27a1de7c3ef5c35e",
	"state": null,
	"propertySources": [
		{
			"name": "http://locahost:10080/tacocloud/tacocloud-config/application.yml",
			"source": {
				"server.port": 0,
				"eureka.client.service-url.defaultZone": "http://eureka1:8761/eureka/"
			}
		}
	]
}
```

- Git 리퍼지터리의 루트 경로가 아니라 서브 디렉터리에 구성 속성을 저장하려면 구성 서버 자체의 속성으로 `spring.loud.config.server.git.search-paths`를 추가하면 된다.
	- ![](assets/Pasted%20image%2020230926210033.png)
- 복수 개의 서브 디렉터리도 가능하다.
	- ![](assets/Pasted%20image%2020230926210053.png)
	- ![](assets/Pasted%20image%2020230926210106.png)
- `spring.cloud.config.server.git.default-label` 속성을 지정하면 기본 라벨이나 브랜치를 변경할 수 있다.
	- 아래의 예에서는 sidework 브랜치가 기본 브랜치가 된다.
	- ![](assets/Pasted%20image%2020230926210747.png)
- Git 리퍼지터리에 접근할 때 인증으로 사용자 이름과 비밀번호를 설정할 수 있다.
	- ![](assets/Pasted%20image%2020230926211014.png)

## 공유되는 구성 데이터 사용하기

- 구성 서버에 접근할 클라이언트 서버 구성 방법
	- 의존성 추가
		- ![](assets/Pasted%20image%2020230926211513.png)
	- `spring.cloud.config.uri` 속성에 구성 서버의 위치 지정
		- ![](assets/Pasted%20image%2020230926211546.png)
- 구성 서버를 서비스 레지스트리(유레카 등)에 등록한 후 클라이언트는 서비스 레지스트리로부터 구성 서버의 위치를 가져오는 방법도 있다.
	- 하지만 이 방법은 마이크로서비스가 시작되는 시점에 두 번의 호출이 필요해진다.
		- 구성 서버를 발견하기 위해 유레카에 호출
		- 구성 데이터를 가져오기 위해 구성 서버에 호출 
- 애플리케이션이 시작되면 구성 서버에 요청해서 속성 값을 받고 이를 캐싱한다. 
	- 따라서 중간에 구성 서버의 실행이 잠깐 중단되더라도 구성 속성을 사용할 수 있다.

## 애플리케이션이나 프로파일에 특정된 속성 제공하기

### 애플리케이션에 특정된 속성 제공하기

- 애플리케이션 이름과 상관없이 모든 애플리케이션은 application.yml 파일의 구성 속성을 받는다.
- 그러나 각 서비스 애플리케이션의 `spring.application.name` 속성이 구성 서버에 요청할 때 요청할 때 전송된다, 그리고 이 속성 값과 일치하는 이름의 구성 파일이 있으면 이 파일에 저장된 속성들이 반환된다.
	- 예: 4개의 마이크로서비스(ingredient-service, order-service, tacoservice, user-service)이 각 서비스 애플리케이션의 `spring.application.name` 속성에 지정하고, 구성 서버의 Git 백엔드에 ingredient-service.yml, order-service.yml, taco-service.yml, user-service.yml이라는 이름의 YAML 구성 파일들을 생성하면 된다.
	- ![](assets/Pasted%20image%2020231016224917.png)
- 만일 application.yml의 공통 속성과 애플리케이션에 특정한 구성 파일의 속성이 중복될 때는 애플리케이션에 특정된 속성들이 우선한다.

### 프로파일로부터 속성 제공하기

- 프로파일에 특정된 속성 지원
	- 프로파일에 특정된 .properties 파일이 YAML 파일을 제공한다. 예: application-production.yml
	- 하나의 YAML 파일 내부에 여러 개의 프로파일 구성 그룹을 포함한다. 3개의 하이픈(---)을 추가하고 그다음에 해당 프로파일의 이름을 나타내는 `spring.config.activate.on-profile` 속성을 지정한다.
- 애플리케이션이 구성 서버로부터 구성을 가져올 때 활성 프로파일을 production으로 알려주면
	- application.yml과 application-production.yml 모두가 반환된다.
	- 프로파일과 애플리케이션 모두에 특정된 속성을 지정하려면 ingredient-service-production.yml과 같은 형식으로 구성 파일의 이름을 지정하면 된다.
	- ![](assets/Pasted%20image%2020231016225419.png)

## 구성 속성들의 보안 유지하기

- 구성 서버에 민감한 정보(비밀번호나 보안 토큰 등)를 포함하는 속성들을 제공해야 할 경우가 있다.
- 보안 구성 속성을 사용할 때 두 가지 옵션
	- Git 백엔드 리퍼지터리에 저장된 구성 파일에 암호화된 값 쓰기
	- Git 백엔드 리퍼지터리에 추가하여 구성 서버의 백엔드 저장소로 해시코프의 Vault 사용하기

### Git 백엔드의 속성들 암호화하기

- 대칭 키를 사용하려면 구성서버 자체 구성의 `encrypt.key` 속성에 키를 설정하면 된다.
	- 아래 속성은 자동-구성이 구성 서버를 활성화시키기 전에 로드되어 사용하기 위해 bootstrap.properties나 bootstrap.yml에 설정되어야 한다.
	- ![](assets/Pasted%20image%2020231016231417.png)
- 한 쌍의 비대칭 RSA나 키스토어의 참조를 사용하도록 구성할 수 있다.
	- ![](assets/Pasted%20image%2020231016231450.png)
	- ![](assets/Pasted%20image%2020231016231456.png)
- 암호화하고자 하는 데이터를 구성 서버의 /encrypt 엔드포인트로 POST 요청을 보내면 된다.
	- ![](assets/Pasted%20image%2020231016231528.png)
- 응답으로 온 암호화된 값을 Git 리퍼지터리에 속성으로 추가하면 된다.
	- `{cipher}` 로 시작하면 암호화된 값이라는 것을 구성 서버에 알려주는 것이다.
	- ![](assets/Pasted%20image%2020231016231606.png)
	- 구성 속성을 요청 하게되면 구성 서버가 복호화 해서 응답한다.
		- ![](assets/Pasted%20image%2020231016231707.png)
- 만일 구성 서버가 복호화하지 않고 그대로 제공하기를 원한다면 `spring.cloud.config.server.encrypt.enabled` 속성을 `false`로 설정하면 된다.
