# 스프링 시큐리티

## 스프링 시큐리티 활성화하기

- Spring 자동 구성을 이용하여 활성화한다.
	- https://www.baeldung.com/spring-boot-security-autoconfiguration
	- 아래 의존에는 `SecurityAutoConfiguration` 클래스가 포함되어 있어서, 자동으로 시큐리티 구성이 된다.

```xml
<dependency> 
	<groupId>org.springframework.boot</groupId> 
	<artifactId>spring-boot-starter-security</artifactId> 
</dependency>
```

- Spring 자동 구성은 다음과 같이 구성된다.
	- 모든 HTTP 요청 경로는 인증되어야 한다.
	- 어떤 특정 역할이나 권한이 없다.
	- 스프링 시큐리티의 기본 HTTP 기본 인증을 사용해서 인증된다.
	- 사용자는 하나만 있으며, 이름은 user다. 비밀번호는 암호화해 준다.

- 시큐리티가 활성화되면 기본적으로 설정되는 프로퍼티가 있다.

```
spring.security.user.name
spring.security.user.password
```

- 따로 설정하지 않았으면 비밀번호가 랜덤으로 생성되면 콘솔 로그에 출력된다.

![](assets/Pasted%20image%2020230530210443.png)

- 페이지로 접속하면 HTTP 기본 인증 대화상자로 리다이렉트 되는 것을 확인할 수 있다.

![](assets/Pasted%20image%2020230530210548.png)

## 스프링 시큐리티 구성하기

### 자동 구성 비활성화

```kotlin
@SpringBootApplication(exclude = [SecurityAutoConfiguration::class])  
class StudyApplication
```

- 이 경우 다른 자동 구성 클래스가 필요할 수도 있어, 실행이 되지 않을 수 있다.
	- 이를 해결하려면 `ManagementWebSecurityAutoConfiguration`도 제외시켜야된다.

### 자동 구성 비활성화 vs 덮어쓰기

- 자동 구성을 비활성화 하는 하는 것은 Spring Security 의존을 추가하고 모든 설정을 처음부터하는 것과 같다.
- 자동 구성을 비활성화하는 경우가 유용한 경우
	- 별도의 security provider을 Spring security와 통합할 때
	- 레거시 Spring 애플리케이션을 Spring Boot로 마이그레이션 중일 때
- 그외에는 대부분 비활성화하지 않는 것이 좋다.
	- 자동 구성이 custom configuration 클래스를 추가해준다.
	- 기본 보안 설정에 커스텀할 부분만 작성하면 되기 때문에 더 간단하다.

### 구성하기

```kotlin
@EnableWebSecurity  
@Configuration  
class SecurityConfig {  
  
   @Bean  
   fun userDetailsService(passwordEncoder: PasswordEncoder): InMemoryUserDetailsManager {  
      val user: UserDetails = User.withUsername("user1")  
         .password("{noop}password1")  
         .authorities("ROLE_USER")  
         .build()  
  
      return InMemoryUserDetailsManager(user)  
   }  
  
   @Bean  
   fun filterChain(http: HttpSecurity): SecurityFilterChain {  
      http.authorizeRequests()  
         .antMatchers("/design", "/orders")  
         .access("hasRole('ROLE_USER')")  
         .antMatchers("/", "/**")  
         .access("permitAll")  
         .and()  
         .httpBasic()  
      return http.build()  
   }  
  
   @Bean  
   fun passwordEncoder(): PasswordEncoder {  
      return PasswordEncoderFactories.createDelegatingPasswordEncoder()  
   }  
}
```

- `@EnableWebSecurity`: 자동 구성을 비활성화하면 필요하다.
- Spring Boot 2에서는 패스워드를 인코딩하기 위한 `PasswordEncoder`가 필요하다.
- `InMemoryUserDetailsManager`: 유저별 데이터를 로드하기 위한 인터페이스인 `UserDetailsService`의 in-memory map 구현체
	- https://docs.spring.io/spring-security/site/docs/4.2.12.RELEASE/apidocs/org/springframework/security/provisioning/InMemoryUserDetailsManager.html
- `SecurityFilterChain`: 해당 보안을 적용할지 여부를 결정하기위한 필터 체인.
- 스프링 5부터는 비밀번호를 암호화해야 하므로 `password()` 메서드를 호출하여 암호화하지 않으면 403 또는 500 HTTP 응답이 발생한다.
	- 간단한 테스트롤 위해 `{noop}`을 지정하여 비밀번호를 암호화하지 않았다.
- 스프링 시큐리티에서는 여러 가지의 사용자 스토어 구성 방법을 제공한다.
	- 인메모리 사용자 스토어
	- JDBC 기반 사용자 스토어
	- LDAP 기반 사용자 스토어
	- 커스텀 사용자 명세 서비스