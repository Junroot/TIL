# Elasticsearch 시작하기

- Elasticsearch 내부 동작을 이해한다.
- Elasticsearch에 새로운 컬럼?을 추가해본다.

## 구조

### 데이터 색인

- 색인(indexing): 데이터가 검색될 수 있는 구조로 변경하기 위해 원본 문서를 검색어 토큰들로 변환하여 저장하는 과정
- 인덱스(index): 색인을 거친 겨로가물, 또는 색인된 데이터가 저장되는 저장소. Elasticsearch에서 도큐먼트들의 논리적인 집합을 표현하는 단위이기도 하다.
- 검색(search): 인덱스에 들어있는 검색어 토큰들을 포함하고 있는 문서를 찾아과는 과정
- 질의(query): 사용자가 원하는 문서를 찾거나 집계 결과를 출력하기 위해 검색 시 입력하는 검색어 또는 검색 조건

### Elasticsearch 환경 설정

- `config/jvm.options`: 힙 메모리 설정 가능하다. 

```
-Xms1g
-Xmx1g
```

- `config/elasticsearch.yml`: elasticsearch 실행 환경에 대한 대부분의 설정
	- `cluster.name: "<클러스터명>"`: 노드들은 클러스터명이 같으면 같은 클러스터로 묶이고, 클러ㅡ터명이 다르면 동일한 물리적 장비나 바인딩이 가능한 네트워크상에 있더라도 서로 다른 클러스터로 바인딩 된다.
	- `node.name: "<노드명>"`: 설정하지않으면 프로세스 UUID의 첫 7글자가 노드명으로 설정된다.
	- `node.attr.<key>: "<value>"`: 노드별로 속성을 부여하기 위한 일종의 네임스페이스
	- `path.data: [ "<경로>" ]`: 색인된 데이터를 저장하는 경로
	- `path.logs: "<경로>"`: 실행 로그를 저장하는 경로
	- `bootstrap.memory_lock: true`: elasticsearch가 사용중인 힙메머리 영역을 달느 자바 프로그램이 간섭 못하도록 미리 점유하는 설정. true 권장.
	- `network.host: <ip 주소>`: elasticsearch가 실행되는 서버의 ip 주소. 디폴트는 루프백(127.0.0.1)이고, 디폴트를 사용할 경우 개발 모드로 실행이 된다. ip 주소를 변경하게 되면 운영모드로 실행된다.
	- `http.port: <포트 번호>`: elasticsearch가 클라이언트와 통신하기 위한 http 포트 설정
	- `transport.port: <포트 번호>`: elasticsearch 노드들 끼리 통신하기 위한 tcp 포트 설정
	- `discovery.seed_hosts: [ "<호스트-1>", "<호스트-2>", ... ]`: 클러스터 구성을 위해 바인딩할 원격 노드들의 IP 또는 도메인 주소를 배열 형태로 입력
	- `cluster.initial_master_nodes: [ "<노드-1>", "<노드-2>" ]`: 클러스터가 최초 실행 될 때 명시된 노드들을 대상으로 마스터 노드를 선출한다.

### 클러스터 구성

- 여러 개의 서버를 하나의 클러스터로 구성
	- ![](assets/Pasted%20image%2020230906184633.png)
	- ![](assets/Pasted%20image%2020230906184646.png)
- 하나의 서버에서 여러 클러스터 실행
	- ![](assets/Pasted%20image%2020230906184703.png)

### 인덱스와 샤드

- 도큐먼트: elasticsearch에서 단일 데이터 단위
- 인덱스: 도큐먼트를 모아놓은 집합
- 샤드: 인덱스가 분리되는 단위로, 각 노드에 분산되어 저장한다.
- 클러스터에 노드를 추가하게 되면 샤드들이 각 노드들로 분산되고 디폴트로 1개의 복제본을 생성한다.
	- 프라이머리 샤드: 처음으로 생성된 샤드
	- 리플리카: 복제본
	- 노드가 1개만 있는 경우는 리플리카가 생성되지 않는다.
	- 프라이머리와 복제본는 반드시 서로 다른 노드에 저장된다.
	- 샤드 수는 인덱스를 처음 생성할 때 지정하며, 인덱스를 재색인 하지 않는 이상 바꿀 수 없다.
	- ![](assets/Pasted%20image%2020230906190109.png)
	- ![](assets/Pasted%20image%2020230906190544.png)

### 마스터 노드와 데이터 노드

- 마스터 노드
	- 인덱스의 메타 데이터, 샤드의 위치와 같은 클러스터 상태 정보를 관리한다.
	- 클러스터마다 하나의 마스터 노드가 존재하며 마스터 노드의 역할을 수행할 수 있는 노드가 없다면 클러스터는 작동이 정지한다.
	- 마스터 역할을 수행하고 있는 노드가 끊어지거나 다운되면 마스터 후보 노드 중 하나가 마스터 노드로 선출된다.
	- 클러스터가 커져서 노드와 샤드의 개수가 많아지게 되면 모든 노드들이 마스터 노드의 정보를 계속 공유하는 것은 부담이 될 수 있어, 마스터 후보 노드들을 따로 설정해서 유지하는 것이 성능에 도움이 된다. (`node.master: false`)
- 데이터 노드
	- 실제로 색인된 데이터를 저장하고 있는 노드
	- 마스터 후보 노드들은 `node.data: false`로 설정하여 마스터 녿 ㅡ역할만 하고 데이터는 저장하지 않도록 할 수 있다.
- 마스터 후보 노드는 홀수개가 좋다. 짝수개면 Split Brain 문제가 발생한다.
	- Split Brain
		- 네트워크 유실로 인해 클러스터가 두개로 분리되면, 각자가 서로 다른 클러스터로 구성되어 계속 동작할 수 있다.
		- 이후에 네트워크가 복구되고 하나의 클러스터로 합쳐졌을 때 데이터 정합성 문제가 생길 수 있다.
		- ![](assets/Pasted%20image%2020230906191928.png)
	- 마스터 후보 노드를 홀수개로 두고, 클러스터가 분리되었을 때 노드의 개수가 과반수보다 적은 경우에는 클러스터 동작을 멈추도록 하면 split brain 문제가 해결된다.
		- ![](assets/Pasted%20image%2020230906192155.png)